<script>
  // Helper to get query param from URL
  function getQueryParam(key) {
    const params = new URLSearchParams(window.location.search);
    return params.get(key);
  }

  const sampleNo = getQueryParam("sample");
  const patients = JSON.parse(localStorage.getItem("patients") || "[]");
  const patient = patients.find(p => p.sampleNo === sampleNo);

  if (!patient) {
    alert("❌ Patient not found.");
  } else {
    document.getElementById("patientName").textContent = patient.name || "N/A";
    document.getElementById("fatherName").textContent = patient.father || "N/A";
    document.getElementById("cnic").textContent = patient.cnic || "N/A";
    document.getElementById("phone").textContent = patient.phone || "N/A";
    document.getElementById("sampleNo").textContent = patient.sampleNo || "N/A";
    document.getElementById("mrnNo").textContent = patient.mrn || "N/A";
    document.getElementById("dob").textContent = patient.dob || "N/A";

    // Test info
    const deptList = patient.tests.map(t => t.section).join(", ");
    const testList = patient.tests.map(t => t.tests.join(", ")).join(", ");

    document.getElementById("department").textContent = deptList || "N/A";
    document.getElementById("testName").textContent = testList || "N/A";
    document.getElementById("date").textContent = new Date(patient.registeredAt).toLocaleDateString();

    const qrData = `
      Alpha Med Clinical Laboratory
      Name: ${patient.name}
      Sample: ${patient.sampleNo}
      MRN: ${patient.mrn}
      CNIC: ${patient.cnic}
    `;
    QRCode.toCanvas(document.getElementById("qrCode"), qrData.trim(), { width: 96 }, err => {
      if (err) console.error(err);
    });
  }
</script>
