<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reception - AlphaMed Clinical Lab</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>üßæ Patient Registration</h1>

    <form id="registrationForm">
      <div class="form-row">
        <label>Patient Name:</label>
        <input type="text" id="patientName" required />
      </div>

      <div class="form-row">
        <label>CNIC:</label>
        <input type="text" id="cnic" required placeholder="e.g. 35201-1234567-8" />
      </div>

      <div class="form-row">
        <label>Phone:</label>
        <input type="tel" id="phone" required placeholder="03XXXXXXXXX" />
      </div>

      <div class="form-row">
        <label>Department:</label>
        <select id="department" required onchange="updateTests()">
          <option value="">-- Select Department --</option>
          <option value="Hematology">Hematology</option>
          <option value="Serology">Serology</option>
          <option value="Histopathology">Histopathology</option>
          <option value="Microbiology">Microbiology</option>
          <option value="Biochemistry">Biochemistry</option>
          <option value="Culture Tests">Culture Tests</option>
          <option value="Special Chemistry">Special Chemistry</option>
          <option value="Molecular Biology">Molecular Biology</option>
          <option value="Blood Banking">Blood Banking</option>
        </select>
      </div>

      <div class="form-row">
        <label>Test:</label>
        <select id="test" required>
          <option value="">-- Select Test --</option>
        </select>
      </div>

      <button type="submit">Register Patient</button>
    </form>

    <div id="qrContainer" style="margin-top: 20px; text-align:center;">
      <h3>üî≥ QR Code</h3>
      <div id="qrCode"></div>
    </div>

    <div style="margin-top: 20px; text-align:center;">
      <button onclick="printSlip()">üñ®Ô∏è Print Registration Slip</button>
    </div>
  </div>

  <script src="labSections.js"></script>
  <script src="qr-generator.js"></script>
  <script>
    // Auto MRN
    function generateMRN() {
      const now = new Date();
      return 'MRN-' + now.getFullYear() + (now.getMonth()+1).toString().padStart(2,'0') + now.getDate().toString().padStart(2,'0') + '-' + Math.floor(Math.random()*1000);
    }

    // Update Test list based on department
    function updateTests() {
      const department = document.getElementById("department").value;
      const testSelect = document.getElementById("test");
      testSelect.innerHTML = "<option value=''>-- Select Test --</option>";

      if (labTests[department]) {
        labTests[department].forEach(test => {
          const option = document.createElement("option");
          option.value = test.name;
          option.text = test.name;
          testSelect.appendChild(option);
        });
      }
    }

    document.getElementById("registrationForm").addEventListener("submit", function(e) {
      e.preventDefault();

      const patientName = document.getElementById("patientName").value;
      const cnic = document.getElementById("cnic").value;
      const phone = document.getElementById("phone").value;
      const department = document.getElementById("department").value;
      const test = document.getElementById("test").value;
      const mrn = generateMRN();

      const patientData = {
        mrn, patientName, cnic, phone, department, test,
        date: new Date().toLocaleDateString()
      };

      // Save to localStorage
      let patients = JSON.parse(localStorage.getItem("patients")) || [];
      patients.push(patientData);
      localStorage.setItem("patients", JSON.stringify(patients));
      localStorage.setItem("lastPatient", JSON.stringify(patientData));

      // Generate QR
      generateQRCode(mrn);

      alert("‚úÖ Patient registered successfully!\nMRN: " + mrn);
    });

    function printSlip() {
      window.open("registration-slip.html", "_blank");
    }
  </script>
</body>
</html>
