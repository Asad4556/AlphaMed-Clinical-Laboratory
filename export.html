function loadResults() {
  const results = JSON.parse(localStorage.getItem("results") || "[]");

  const from = new Date(document.querySelector("#fromDate").value);
  const to = new Date(document.querySelector("#toDate").value);
  const department = document.querySelector("#department").value;

  const filtered = results.filter(r => {
    const date = new Date(r.date);
    const matchDept = department ? r.department === department : true;
    const matchDate = (!isNaN(from) ? date >= from : true) && (!isNaN(to) ? date <= to : true);
    return matchDept && matchDate;
  });

  const tbody = document.querySelector("#resultsBody");
  tbody.innerHTML = "";

  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="5" class="p-3 text-center text-gray-500">No results found for the selected filters.</td></tr>`;
  }

  filtered.forEach(r => {
    r.tests.forEach(test => {
      const row = `
        <tr class="border-b">
          <td class="p-3">${r.name}</td>
          <td class="p-3">${r.mrn}</td>
          <td class="p-3">${test.name}</td>
          <td class="p-3">${r.date}</td>
          <td class="p-3">${test.result}</td>
        </tr>
      `;
      tbody.innerHTML += row;
    });
  });

  return filtered;
}

function exportExcel() {
  const data = loadResults();
  if (data.length === 0) {
    alert("No results to export.");
    return;
  }

  const rows = [["Patient Name", "MRN", "Test", "Date", "Result"]];
  data.forEach(r => {
    r.tests.forEach(test => {
      rows.push([r.name, r.mrn, test.name, r.date, test.result]);
    });
  });

  const ws = XLSX.utils.aoa_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Reports");
  XLSX.writeFile(wb, "Reports.xlsx");

  alert("Excel file has been exported.");
}

async function exportPDF() {
  const data = loadResults();
  if (data.length === 0) {
    alert("No results to export.");
    return;
  }

  const rows = [];
  data.forEach(r => {
    r.tests.forEach(test => {
      rows.push([r.name, r.mrn, test.name, r.date, test.result]);
    });
  });

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(14);
  doc.text("Exported Reports", 14, 15);

  doc.autoTable({
    startY: 20,
    head: [["Patient Name", "MRN", "Test", "Date", "Result"]],
    body: rows,
  });

  doc.save("Reports.pdf");

  alert("PDF file has been exported.");
}
