<!DOCTYPE html>
<html lang="ur">
<head>
  <meta charset="UTF-8">
  <title>ٹیکنیشن ڈیش بورڈ</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-6xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">🧪 ٹیسٹ رزلٹ داخل کریں</h1>

    <div id="patientList" class="space-y-4">
      <!-- مریضوں کی فہرست یہاں آۓ گی -->
    </div>
  </div>

  <script src="storage.js"></script>
  <script>
    function loadPatients() {
      const listContainer = document.getElementById("patientList");
      listContainer.innerHTML = "";

      const patients = JSON.parse(localStorage.getItem("registeredPatients") || "[]");

      if (patients.length === 0) {
        listContainer.innerHTML = "<p>📭 کوئی مریض رجسٹر نہیں ہے۔</p>";
        return;
      }

      patients.forEach((patient, index) => {
        const card = document.createElement("div");
        card.className = "bg-white p-4 rounded shadow";

        card.innerHTML = `
          <h2 class="text-lg font-semibold mb-2">${patient.name} (MRN: ${patient.mrn})</h2>
          <p><strong>CNIC:</strong> ${patient.cnic} | <strong>Sample#:</strong> ${patient.sampleNo}</p>
          <form data-index="${index}" class="mt-3 space-y-2">
            ${renderTests(patient.selectedTests)}
            <button type="submit" class="btn bg-green-600 text-white">💾 محفوظ کریں</button>
          </form>
        `;

        card.querySelector("form").addEventListener("submit", function (e) {
          e.preventDefault();
          saveResults(this);
        });

        listContainer.appendChild(card);
      });
    }

    function renderTests(tests) {
      let html = "";
      tests.forEach((test, i) => {
        html += `<div class="border p-2 rounded mb-2">
          <strong>${test.name}</strong>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-2">
            ${test.parameters.map((param, j) => `
              <label>
                ${param.name} (${param.unit}) [${param.range}]:
                <input type="text" name="result-${i}-${j}" value="${param.result || ''}" class="input w-full" />
              </label>
            `).join("")}
          </div>
        </div>`;
      });
      return html;
    }

    function saveResults(form) {
      const index = form.getAttribute("data-index");
      const patients = JSON.parse(localStorage.getItem("registeredPatients") || "[]");
      const patient = patients[index];

      patient.selectedTests.forEach((test, i) => {
        test.parameters.forEach((param, j) => {
          const result = form.querySelector(`[name="result-${i}-${j}"]`).value;
          param.result = result;
        });
      });

      patients[index] = patient;
      localStorage.setItem("registeredPatients", JSON.stringify(patients));
      alert("✅ رزلٹ محفوظ ہو گیا۔");
    }

    loadPatients();
  </script>
</body>
</html>
