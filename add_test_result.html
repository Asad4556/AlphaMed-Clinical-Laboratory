<script>
  function logout() {
    localStorage.removeItem("loggedIn");
    window.location.href = "login.html";
  }

  function loadTests() {
    const mrn = document.getElementById("mrn").value.trim();
    if (!mrn) {
      alert("Ø¨Ø±Ø§Û Ú©Ø±Ù… MRN Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº");
      return;
    }

    const patients = JSON.parse(localStorage.getItem("patientList") || "[]");
    const patient = patients.find(p => p.mrn === mrn);

    if (!patient) {
      alert("Ù…Ø±ÛŒØ¶ Ù†ÛÛŒÚº Ù…Ù„Ø§");
      return;
    }

    if (!patient.selectedTests || patient.selectedTests.length === 0) {
      alert("Ø§Ø³ Ù…Ø±ÛŒØ¶ Ú©Û’ Ù„Ø¦Û’ Ú©ÙˆØ¦ÛŒ Ù¹ÛŒØ³Ù¹ Ù…Ù†ØªØ®Ø¨ Ù†ÛÛŒÚº ÛÙˆØ¦Û’");
      return;
    }

    let html = `<h3>ğŸ‘¤ ${patient.name}</h3>`;
    html += `<table><tr><th>Ù¹ÛŒØ³Ù¹</th><th>Ø±ÛŒØ²Ù„Ù¹</th><th>Ù†Ø§Ø±Ù…Ù„</th><th>Status</th></tr>`;

    patient.selectedTests.forEach((test, index) => {
      html += `
        <tr>
          <td>${test.name}</td>
          <td><input type="text" id="result-${index}" placeholder="Ø±ÛŒØ²Ù„Ù¹ Ù„Ú©Ú¾ÛŒÚº" /></td>
          <td>${test.normal}</td>
          <td id="status-${index}">-</td>
        </tr>
      `;
    });

    html += `</table><br><button onclick="saveReport('${mrn}')">ğŸ’¾ Ø±Ù¾ÙˆØ±Ù¹ Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚº</button>`;
    document.getElementById("test-area").innerHTML = html;
  }

  function saveReport(mrn) {
    const patients = JSON.parse(localStorage.getItem("patientList") || "[]");
    const patient = patients.find(p => p.mrn === mrn);
    const results = [];

    patient.selectedTests.forEach((test, index) => {
      const input = document.getElementById(`result-${index}`);
      const status = document.getElementById(`status-${index}`);
      const resultValue = parseFloat(input.value.trim());
      let arrow = "", statusText = "";

      if (test.normal.includes('-')) {
        const [low, high] = test.normal.split('-').map(parseFloat);
        if (resultValue < low) {
          arrow = "â†“";
          statusText = "Ú©Ù…";
          status.style.color = "orange";
        } else if (resultValue > high) {
          arrow = "â†‘";
          statusText = "Ø²ÛŒØ§Ø¯Û";
          status.style.color = "red";
        } else {
          arrow = "âœ”ï¸";
          statusText = "Ù†Ø§Ø±Ù…Ù„";
          status.style.color = "lightgreen";
        }
      } else {
        arrow = "âœ”ï¸";
        statusText = "Ù†Ø§Ø±Ù…Ù„";
        status.style.color = "lightgreen";
      }

      status.innerText = arrow;

      results.push({
        test: test.name,
        result: resultValue,
        normal: test.normal,
        status: statusText,
        arrow: arrow
      });
    });

    const allReports = JSON.parse(localStorage.getItem("labReports") || "[]");
    allReports.push({
      mrn: mrn,
      results: results,
      date: new Date().toISOString()
    });

    localStorage.setItem("labReports", JSON.stringify(allReports));
    alert("Ø±Ù¾ÙˆØ±Ù¹ Ù…Ø­ÙÙˆØ¸ ÛÙˆ Ú¯Ø¦ÛŒ âœ…");
    location.reload();
  }
</script>
