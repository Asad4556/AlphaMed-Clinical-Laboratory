<script>
  function logout() {
    localStorage.removeItem("loggedIn");
    window.location.href = "login.html";
  }

  function loadTests() {
    const mrn = document.getElementById("mrn").value.trim();
    if (!mrn) {
      alert("براہ کرم MRN درج کریں");
      return;
    }

    const patients = JSON.parse(localStorage.getItem("patientList") || "[]");
    const patient = patients.find(p => p.mrn === mrn);

    if (!patient) {
      alert("مریض نہیں ملا");
      return;
    }

    if (!patient.selectedTests || patient.selectedTests.length === 0) {
      alert("اس مریض کے لئے کوئی ٹیسٹ منتخب نہیں ہوئے");
      return;
    }

    let html = `<h3>👤 ${patient.name}</h3>`;
    html += `<table><tr><th>ٹیسٹ</th><th>ریزلٹ</th><th>نارمل</th><th>Status</th></tr>`;

    patient.selectedTests.forEach((test, index) => {
      html += `
        <tr>
          <td>${test.name}</td>
          <td><input type="text" id="result-${index}" placeholder="ریزلٹ لکھیں" /></td>
          <td>${test.normal}</td>
          <td id="status-${index}">-</td>
        </tr>
      `;
    });

    html += `</table><br><button onclick="saveReport('${mrn}')">💾 رپورٹ محفوظ کریں</button>`;
    document.getElementById("test-area").innerHTML = html;
  }

  function saveReport(mrn) {
    const patients = JSON.parse(localStorage.getItem("patientList") || "[]");
    const patient = patients.find(p => p.mrn === mrn);
    const results = [];

    patient.selectedTests.forEach((test, index) => {
      const input = document.getElementById(`result-${index}`);
      const status = document.getElementById(`status-${index}`);
      const resultValue = parseFloat(input.value.trim());
      let arrow = "", statusText = "";

      if (test.normal.includes('-')) {
        const [low, high] = test.normal.split('-').map(parseFloat);
        if (resultValue < low) {
          arrow = "↓";
          statusText = "کم";
          status.style.color = "orange";
        } else if (resultValue > high) {
          arrow = "↑";
          statusText = "زیادہ";
          status.style.color = "red";
        } else {
          arrow = "✔️";
          statusText = "نارمل";
          status.style.color = "lightgreen";
        }
      } else {
        arrow = "✔️";
        statusText = "نارمل";
        status.style.color = "lightgreen";
      }

      status.innerText = arrow;

      results.push({
        test: test.name,
        result: resultValue,
        normal: test.normal,
        status: statusText,
        arrow: arrow
      });
    });

    const allReports = JSON.parse(localStorage.getItem("labReports") || "[]");
    allReports.push({
      mrn: mrn,
      results: results,
      date: new Date().toISOString()
    });

    localStorage.setItem("labReports", JSON.stringify(allReports));
    alert("رپورٹ محفوظ ہو گئی ✅");
    location.reload();
  }
</script>
