<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Test Results - AlphaMed Lab</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>Add Test Results</h1>

  <div>
    <p><strong>Patient Name:</strong> <span id="patientName"></span></p>
    <p><strong>MRN:</strong> <span id="patientMRN"></span></p>
  </div>

  <form id="testResultForm">
    <div id="resultInputs"></div>
    <br />
    <button type="button" onclick="saveTestResults()">Save Results</button>
  </form>

  <script src="test-data.js"></script>
  <script>
    // Load patient info and tests for selected MRN from localStorage
    function loadAddResultPage() {
      const mrn = localStorage.getItem("selectedMRN");
      if (!mrn) {
        alert("No patient selected!");
        window.location.href = "technician_dashboard.html";
        return;
      }

      const patients = JSON.parse(localStorage.getItem("patients")) || [];
      const patient = patients.find(p => p.mrn === mrn);
      if (!patient) {
        alert("Patient not found!");
        window.location.href = "technician_dashboard.html";
        return;
      }

      document.getElementById("patientName").innerText = patient.name;
      document.getElementById("patientMRN").innerText = patient.mrn;

      const container = document.getElementById("resultInputs");
      container.innerHTML = "";

      // patient.section expected to be an array of section names
      patient.section.forEach(section => {
        const tests = testData[section];
        if (!tests) return;

        const sectionTitle = document.createElement("h3");
        sectionTitle.innerText = section;
        container.appendChild(sectionTitle);

        tests.forEach(test => {
          const div = document.createElement("div");
          div.innerHTML = `
            <label for="${test.test.replace(/\s+/g, "_")}">${test.test} (${test.normal || ""}): </label>
            <input type="text" id="${test.test.replace(/\s+/g, "_")}" name="${test.test.replace(/\s+/g, "_")}" />
            <br />
          `;
          container.appendChild(div);
        });
      });
    }

    // Save test results back to the patient object in localStorage
    function saveTestResults() {
      const mrn = localStorage.getItem("selectedMRN");
      if (!mrn) {
        alert("No patient selected!");
        return;
      }

      let patients = JSON.parse(localStorage.getItem("patients")) || [];
      const patientIndex = patients.findIndex(p => p.mrn === mrn);
      if (patientIndex === -1) {
        alert("Patient not found!");
        return;
      }

      // Initialize results object if it doesn't exist
      patients[patientIndex].results = patients[patientIndex].results || {};

      patients[patientIndex].section.forEach(section => {
        const tests = testData[section];
        if (!tests) return;

        tests.forEach(test => {
          const val = document.getElementById(test.test.replace(/\s+/g, "_")).value;
          patients[patientIndex].results[test.test] = val;
        });
      });

      localStorage.setItem("patients", JSON.stringify(patients));
      alert("Results saved successfully!");
      window.location.href = "technician_dashboard.html";
    }

    loadAddResultPage();
  </script>
</body>
</html>
