<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Add Test Result - Alpha Med</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="storage.js"></script> <!-- Make sure it's included -->
</head>
<body class="bg-gray-100 min-h-screen p-4">

  <div class="max-w-5xl mx-auto bg-white shadow-lg p-6 rounded-xl">
    <h1 class="text-2xl font-bold text-blue-700 mb-4">üß™ Add Test Result - Alpha Med Clinical Lab</h1>

    <!-- Patient Info -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
      <input type="text" placeholder="Enter MRN (e.g. MRN-123456)" class="input" id="mrnInput">
      <button onclick="loadPatient()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">üîç Load</button>
    </div>

    <div id="patientInfo" class="mb-6 hidden">
      <p><strong>Name:</strong> <span id="pName"></span></p>
      <p><strong>Sample No:</strong> <span id="pSample"></span></p>
      <p><strong>Department:</strong> <span id="pDept"></span></p>
    </div>

    <!-- Assigned Tests -->
    <div class="mb-6 hidden" id="testSection">
      <h2 class="text-lg font-semibold mb-2">Assigned Tests</h2>
      <div id="testList" class="space-y-2"></div>
    </div>

    <!-- Submit -->
    <div class="text-right hidden" id="submitSection">
      <button onclick="submitResults()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">‚úÖ Submit Results</button>
    </div>
  </div>

  <script>
    let currentMRN = "";
    let testInputs = [];

    function loadPatient() {
      const mrn = document.getElementById("mrnInput").value.trim();
      if (!mrn) return alert("Please enter MRN");

      const patients = getFromStorage("patients");
      const tests = getFromStorage("reception_tests");

      const patient = patients.find(p => p.mrn === mrn);
      if (!patient) return alert("Patient not found");

      const assignedTests = tests.filter(t => t.mrn === mrn);
      if (assignedTests.length === 0) return alert("No tests assigned to this patient");

      // Fill UI
      document.getElementById("pName").innerText = patient.name;
      document.getElementById("pSample").innerText = patient.sampleNo;
      document.getElementById("pDept").innerText = patient.department;

      document.getElementById("patientInfo").classList.remove("hidden");
      document.getElementById("testSection").classList.remove("hidden");
      document.getElementById("submitSection").classList.remove("hidden");

      const testListDiv = document.getElementById("testList");
      testListDiv.innerHTML = "";
      testInputs = [];

      assignedTests.forEach((test, index) => {
        const row = document.createElement("div");
        row.className = "grid grid-cols-3 gap-2";

        row.innerHTML = `
          <input type="text" class="input" value="${test.name}" disabled />
          <input type="text" placeholder="Enter Result" class="input" id="result-${index}">
          <input type="text" class="input" value="${test.normalRange}" disabled />
        `;

        testListDiv.appendChild(row);
        testInputs.push({
          name: test.name,
          range: test.normalRange,
          inputId: `result-${index}`,
        });
      });

      currentMRN = mrn;
    }

    function submitResults() {
      const results = [];

      for (const test of testInputs) {
        const value = document.getElementById(test.inputId).value.trim();
        if (!value) return alert(`Result missing for: ${test.name}`);

        results.push({
          mrn: currentMRN,
          testName: test.name,
          result: value,
          normalRange: test.range,
        });
      }

      const allResults = getFromStorage("test_results");
      saveToStorage("test_results", [...allResults, ...results]);

      alert("Test results submitted successfully!");
      location.reload();
    }
  </script>

  <style>
    .input {
      @apply border border-gray-300 rounded px-3 py-2 w-full;
    }
  </style>

</body>
</html>
