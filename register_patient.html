<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Register Patient - Alpha Med</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <!-- Custom Scripts -->
  <script src="storage.js"></script>
</head>
<body class="bg-gray-100 p-6">

  <h1 class="text-2xl font-bold mb-4">üìù Register Patient</h1>

  <!-- Form -->
  <div class="bg-white p-4 rounded shadow mb-6">
    <form id="patientForm" class="space-y-4">
      <div>
        <label class="block">Patient Name</label>
        <input type="text" id="name" required class="w-full border px-2 py-1 rounded"/>
      </div>
      <div>
        <label class="block">Father Name / S/o</label>
        <input type="text" id="father" required class="w-full border px-2 py-1 rounded"/>
      </div>
      <div>
        <label class="block">CNIC</label>
        <input type="text" id="cnic" required class="w-full border px-2 py-1 rounded"/>
      </div>
      <div>
        <label class="block">Phone No</label>
        <input type="text" id="phone" required class="w-full border px-2 py-1 rounded"/>
      </div>
      <div>
        <label class="block">Age (dd-mm-yyyy)</label>
        <input type="text" id="age" required class="w-full border px-2 py-1 rounded"/>
      </div>

      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Save Patient</button>
    </form>
  </div>

  <!-- QR Code Preview -->
  <div id="qrPreview" class="mb-6"></div>

  <!-- Patient List -->
  <div class="bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-2">üìã Registered Patients</h2>
    <ul id="patientList" class="text-sm space-y-2"></ul>
  </div>

  <script>
    const form = document.getElementById("patientForm");
    const list = document.getElementById("patientList");
    const qr = document.getElementById("qrPreview");

    function renderPatients() {
      const patients = getFromStorage("patients");
      list.innerHTML = patients.map(p => `
        <li class="border-b py-1">
          <strong>${p.name}</strong> (MRN: ${p.mrn}, Sample: ${p.sampleNo}) - ${p.phone}
        </li>
      `).join("");
    }

    form.onsubmit = e => {
      e.preventDefault();

      const newPatient = {
        name: name.value,
        father: father.value,
        cnic: cnic.value,
        phone: phone.value,
        age: age.value,
        mrn: generateID("MRN"),
        sampleNo: generateID("SMP"),
        registeredAt: new Date().toLocaleString()
      };

      addToStorage("patients", newPatient);
      generateQRCode(newPatient);
      renderPatients();
      form.reset();
    };

    function generateQRCode(patient) {
      const qrData = `Alpha Med Lab\nName: ${patient.name}\nMRN: ${patient.mrn}\nSample: ${patient.sampleNo}\nPhone: ${patient.phone}`;
      QRCode.toCanvas(document.createElement("canvas"), qrData, function (err, canvas) {
        if (!err) {
          qr.innerHTML = "";
          qr.appendChild(canvas);
        }
      });
    }

    renderPatients();
  </script>
</body>
</html>
