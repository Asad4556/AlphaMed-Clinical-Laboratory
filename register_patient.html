<!DOCTYPE html>
<html lang="ur">
<head>
  <meta charset="UTF-8" />
  <title>Ù…Ø±ÛŒØ¶ Ú©Ø§ Ø§Ù†Ø¯Ø±Ø§Ø¬</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-4xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">ğŸ“ Ù…Ø±ÛŒØ¶ Ú©Ø§ Ø§Ù†Ø¯Ø±Ø§Ø¬</h1>

    <div class="bg-white p-4 rounded shadow mb-4">
      <label>Ù†Ø§Ù…:</label>
      <input type="text" id="patientName" class="input" placeholder="Ù†Ø§Ù… Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº" />
      
      <label class="mt-2 block">CNIC:</label>
      <input type="text" id="patientCnic" class="input" placeholder="xxxxx-xxxxxxx-x" />

      <label class="mt-2 block">Sample Ù†Ù…Ø¨Ø±:</label>
      <input type="text" id="sampleNo" class="input" placeholder="Sample No" />

      <label class="mt-2 block">Ù¹ÛŒØ³Ù¹ Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº:</label>
      <div id="testSelectionContainer" class="mb-4"></div>

      <button onclick="registerPatient()" class="btn bg-blue-600 hover:bg-blue-700 text-white">âœ… Ø±Ø¬Ø³Ù¹Ø± Ú©Ø±ÛŒÚº</button>
    </div>

    <div id="qrContainer" class="mt-4 hidden">
      <h2 class="font-semibold mb-2">ğŸ”³ QR Ú©ÙˆÚˆ</h2>
      <canvas id="qr"></canvas>
    </div>
  </div>

  <script src="test-data.js"></script>
  <script src="storage.js"></script>
  <script>
    function generateMRN() {
      const prefix = "MRN";
      const id = Date.now().toString().slice(-6);
      return `${prefix}-${id}`;
    }

    function renderTestSelection() {
      const container = document.getElementById("testSelectionContainer");
      labDepartments.forEach((dept, i) => {
        const section = document.createElement("div");
        section.className = "mb-2";
        section.innerHTML = `<strong>${dept.name}</strong>`;

        dept.tests.forEach((test, j) => {
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = `test-${i}-${j}`;
          checkbox.value = test.name;
          checkbox.className = "mr-2";

          const label = document.createElement("label");
          label.htmlFor = checkbox.id;
          label.textContent = test.name;

          const div = document.createElement("div");
          div.appendChild(checkbox);
          div.appendChild(label);

          section.appendChild(div);
        });

        container.appendChild(section);
      });
    }

    function registerPatient() {
      const name = document.getElementById("patientName").value.trim();
      const cnic = document.getElementById("patientCnic").value.trim();
      const sampleNo = document.getElementById("sampleNo").value.trim();

      if (!name || !cnic || !sampleNo) {
        alert("Ø¨Ø±Ø§Û Ú©Ø±Ù… ØªÙ…Ø§Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ”");
        return;
      }

      const mrn = generateMRN();

      const selectedTests = [];

      labDepartments.forEach((dept) => {
        dept.tests.forEach((test) => {
          const id = `test-${labDepartments.indexOf(dept)}-${dept.tests.indexOf(test)}`;
          const checkbox = document.getElementById(id);
          if (checkbox && checkbox.checked) {
            selectedTests.push({ 
              name: test.name,
              parameters: test.parameters.map(p => ({ ...p, result: "" }))
            });
          }
        });
      });

      const patient = {
        mrn,
        name,
        cnic,
        sampleNo,
        selectedTests
      };

      const patients = JSON.parse(localStorage.getItem("registeredPatients") || "[]");
      patients.push(patient);
      localStorage.setItem("registeredPatients", JSON.stringify(patients));

      generateQRCode(mrn);
      alert("âœ… Ù…Ø±ÛŒØ¶ Ø±Ø¬Ø³Ù¹Ø± ÛÙˆ Ú¯ÛŒØ§ ÛÛ’");
    }

    function generateQRCode(mrn) {
      const qr = new QRious({
        element: document.getElementById("qr"),
        value: mrn,
        size: 200
      });
      document.getElementById("qrContainer").classList.remove("hidden");
    }

    renderTestSelection();
  </script>
</body>
</html>
