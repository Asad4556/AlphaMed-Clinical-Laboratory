<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Register Patient - Alpha Med</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body class="bg-gray-100 p-6">

  <h1 class="text-2xl font-bold mb-4">üìù Register Patient</h1>

  <!-- Form -->
  <div class="bg-white p-4 rounded shadow mb-6">
    <form id="patientForm" class="space-y-4">
      <div>
        <label class="block font-semibold mb-1">Patient Name</label>
        <input type="text" id="name" required class="w-full border px-2 py-1 rounded"/>
      </div>
      <div>
        <label class="block font-semibold mb-1">Father Name / S/o</label>
        <input type="text" id="father" required class="w-full border px-2 py-1 rounded"/>
      </div>
      <div>
        <label class="block font-semibold mb-1">CNIC</label>
        <input type="text" id="cnic" required class="w-full border px-2 py-1 rounded"/>
      </div>
      <div>
        <label class="block font-semibold mb-1">Phone No</label>
        <input type="text" id="phone" required class="w-full border px-2 py-1 rounded"/>
      </div>
      <div>
        <label class="block font-semibold mb-1">Date of Birth</label>
        <input type="date" id="dob" required class="w-full border px-2 py-1 rounded"/>
      </div>

      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">Save Patient</button>
    </form>
  </div>

  <!-- QR Code Preview -->
  <div id="qrPreview" class="mb-6"></div>

  <!-- Patient List -->
  <div class="bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-2">üìã Registered Patients</h2>
    <ul id="patientList" class="text-sm space-y-2"></ul>
  </div>

  <script>
    // Storage helper functions
    function getFromStorage(key) {
      const data = localStorage.getItem(key);
      return data ? JSON.parse(data) : [];
    }
    function addToStorage(key, item) {
      const arr = getFromStorage(key);
      arr.push(item);
      localStorage.setItem(key, JSON.stringify(arr));
    }

    // Simple ID generator based on timestamp + random
    function generateID(prefix) {
      return `${prefix}-${Date.now().toString().slice(-6)}${Math.floor(Math.random() * 900 + 100)}`;
    }

    const form = document.getElementById("patientForm");
    const list = document.getElementById("patientList");
    const qr = document.getElementById("qrPreview");

    function renderPatients() {
      const patients = getFromStorage("patients");
      if (patients.length === 0) {
        list.innerHTML = `<li class="text-gray-500">No patients registered yet.</li>`;
        return;
      }
      list.innerHTML = patients.map(p => `
        <li class="border-b py-1">
          <strong>${p.name}</strong> (MRN: ${p.mrn}, Sample: ${p.sampleNo}) - ${p.phone}
        </li>
      `).join("");
    }

    function generateQRCode(patient) {
      const qrData = `Alpha Med Lab\nName: ${patient.name}\nMRN: ${patient.mrn}\nSample: ${patient.sampleNo}\nPhone: ${patient.phone}`;
      QRCode.toCanvas(qr, qrData, function (err) {
        if (err) {
          qr.innerHTML = "Failed to generate QR code";
        }
      });
    }

    form.onsubmit = e => {
      e.preventDefault();

      const newPatient = {
        name: form.name.value.trim(),
        father: form.father.value.trim(),
        cnic: form.cnic.value.trim(),
        phone: form.phone.value.trim(),
        dob: form.dob.value,
        mrn: generateID("MRN"),
        sampleNo: generateID("SMP"),
        registeredAt: new Date().toLocaleString()
      };

      addToStorage("patients", newPatient);
      generateQRCode(newPatient);
      renderPatients();
      form.reset();
    };

    renderPatients();
  </script>
</body>
</html>
