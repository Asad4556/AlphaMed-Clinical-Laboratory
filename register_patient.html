<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Register Patient - Alpha Med</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="test-data.js"></script> <!-- ‚úÖ Test data external file -->
</head>
<body class="bg-gray-100 p-6 text-gray-800">

  <h1 class="text-2xl font-bold mb-6 text-blue-700">üìù Patient Registration</h1>

  <div class="bg-white p-6 rounded-xl shadow-lg">
    <form id="patientForm" class="space-y-5">

      <!-- Patient Info -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block font-semibold mb-1">Patient Name</label>
          <input type="text" id="name" required class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block font-semibold mb-1">Father Name</label>
          <input type="text" id="father" required class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block font-semibold mb-1">CNIC</label>
          <input type="text" id="cnic" required class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block font-semibold mb-1">Phone No</label>
          <input type="text" id="phone" required class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block font-semibold mb-1">Date of Birth</label>
          <input type="date" id="dob" required class="w-full border rounded px-3 py-2" />
        </div>
      </div>

      <!-- Lab Sections & Tests -->
      <div class="mt-8">
        <h2 class="text-lg font-semibold mb-4">üî¨ Select Lab Sections & Tests</h2>
        <div id="labSections" class="space-y-4">
          <!-- Will populate from test-data.js -->
        </div>
      </div>

      <!-- Submit -->
      <button type="submit" class="mt-6 bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
        üíæ Register Patient
      </button>
    </form>
  </div>

  <script>
    function generateID(prefix) {
      return `${prefix}-${Date.now().toString().slice(-6)}${Math.floor(Math.random() * 900 + 100)}`;
    }

    function getFromStorage(key) {
      const data = localStorage.getItem(key);
      return data ? JSON.parse(data) : [];
    }

    function addToStorage(key, item) {
      const items = getFromStorage(key);
      items.push(item);
      localStorage.setItem(key, JSON.stringify(items));
    }

    // Populate Sections & Tests
    function populateSections() {
      const container = document.getElementById("labSections");

      if (!window.labSectionsData || !Array.isArray(window.labSectionsData)) {
        container.innerHTML = "<p class='text-red-500'>‚ùå Test data not loaded.</p>";
        return;
      }

      window.labSectionsData.forEach(section => {
        const wrapper = document.createElement("div");
        wrapper.className = "bg-gray-50 border rounded p-4";

        const title = document.createElement("h3");
        title.className = "font-bold mb-2 text-blue-600";
        title.textContent = section.name;
        wrapper.appendChild(title);

        section.tests.forEach(test => {
          const label = document.createElement("label");
          label.className = "block text-sm mb-1";
          label.innerHTML = `
            <input type="checkbox" data-section="${section.name}" value="${test}" class="mr-2">
            ${test}
          `;
          wrapper.appendChild(label);
        });

        container.appendChild(wrapper);
      });
    }

    // Handle Form Submit
    document.getElementById("patientForm").addEventListener("submit", function (e) {
      e.preventDefault();

      const patient = {
        name: document.getElementById("name").value.trim(),
        father: document.getElementById("father").value.trim(),
        cnic: document.getElementById("cnic").value.trim(),
        phone: document.getElementById("phone").value.trim(),
        dob: document.getElementById("dob").value,
        mrn: generateID("MRN"),
        sampleNo: generateID("SMP"),
        registeredAt: new Date().toLocaleString(),
        tests: []
      };

      const checkboxes = document.querySelectorAll('#labSections input[type="checkbox"]:checked');
      const grouped = {};
      checkboxes.forEach(cb => {
        const section = cb.dataset.section;
        if (!grouped[section]) grouped[section] = [];
        grouped[section].push(cb.value);
      });

      for (const section in grouped) {
        patient.tests.push({ section: section, tests: grouped[section] });
      }

      if (patient.tests.length === 0) {
        alert("‚ö†Ô∏è Please select at least one test.");
        return;
      }

      addToStorage("patients", patient);
      alert("‚úÖ Patient registered successfully.");
      this.reset();
    });

    // Load Sections on Page Load
    window.onload = populateSections;
  </script>
</body>
</html>
