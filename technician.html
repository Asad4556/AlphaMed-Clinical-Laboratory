// technician.js

document.getElementById("searchBtn").addEventListener("click", function () {
  const query = document.getElementById("searchInput").value.trim();
  const patients = getFromStorage("patients");

  const found = patients.find(p =>
    p.cnic === query || p.mrn === query
  );

  if (found) {
    showPatient(found);
  } else {
    alert("Patient not found!");
  }
});

function showPatient(patient) {
  document.getElementById("patientInfo").classList.remove("hidden");
  document.getElementById("resultForm").classList.remove("hidden");

  document.getElementById("pName").textContent = patient.name;
  document.getElementById("pMRN").textContent = patient.mrn;
  document.getElementById("pSample").textContent = patient.sampleNo;

  // Clear old fields
  const testFields = document.getElementById("testFields");
  testFields.innerHTML = "";

  // Show test fields
  (patient.tests || []).forEach(test => {
    const field = document.createElement("div");
    field.innerHTML = `
      <label class="block font-medium">${test.name}</label>
      <input type="text" name="${test.name}" class="input-box w-full" placeholder="Enter result" />
    `;
    testFields.appendChild(field);
  });

  // Attach submit handler
  document.getElementById("resultForm").onsubmit = function (e) {
    e.preventDefault();

    const formData = new FormData(e.target);
    const results = {};
    for (let pair of formData.entries()) {
      results[pair[0]] = pair[1];
    }

    // Update patient record
    updateStorage("patients", p => p.mrn === patient.mrn, old => ({
      ...old,
      results,
      status: "results-added"
    }));

    alert("âœ… Test results saved!");
    e.target.reset();
  };
}
